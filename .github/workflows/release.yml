name: Create PDF Release

on:
  push:
    branches:
      - pdf

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set date
        id: date
        run: |
          $date = Get-Date -Format "yyyyMMdd"
          echo "date=$date" >> $env:GITHUB_OUTPUT

      - name: Create PDF package
        run: |
          $date = "${{ steps.date.outputs.date }}"
          # 创建目录
          New-Item -ItemType Directory -Force -Path "build"
          
          # 收集並檢查PDF
          $pdfs = Get-ChildItem -File -Filter *.pdf
          if (-not $pdfs) {
            Write-Error "No PDF files found in the repository root.";
            exit 1
          }
          
          # 复制所有PDF文件
          $pdfs | Copy-Item -Destination "build\" -Force
          
          # 打包为ZIP
          Compress-Archive -Path "build\*.pdf" -DestinationPath "build\PDF-$date.zip" -Force
        

      - name: Delete old ZIP files
        run: |
          $date = "${{ steps.date.outputs.date }}"
          # 获取所有ZIP文件
          $files = Get-ChildItem -Filter "PDF-*.zip" -Path "build\"
          foreach ($file in $files) {
            if ($file.Name -notlike "*$date.zip") {
              Remove-Item -Path $file.FullName -Force
            }
          }
        

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: Release latest
          body: |
            此處存放自動生成的 ZIP 壓縮包，始終爲最新版本。

            更新內容：
            1. 修訂字音表；2. 修訂詞表；3. 完善PDF顯示
            待解決問題：部分生僻字和下標字符在PDF顯示有問題，有待解決
          files: build\PDF-${{ steps.date.outputs.date }}.zip
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Delete old ZIP assets from Release
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const release = await github.rest.repos.getReleaseByTag({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag: 'latest'
            });
            const assets = release.data.assets;
            const today = '${{ steps.date.outputs.date }}';
            for (const asset of assets) {
              if (
                asset.name.startsWith('PDF-') &&
                !asset.name.includes(today) &&
                asset.name.endsWith('.zip')
              ) {
                await github.rest.repos.deleteReleaseAsset({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  asset_id: asset.id
                });
                console.log(`Deleted old ZIP asset: ${asset.name}`);
              }
            }